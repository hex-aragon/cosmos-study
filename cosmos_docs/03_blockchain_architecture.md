# 블록체인 아키텍쳐

## 상태 기계

- 블록체인의 핵심은 복제된 결정론적 상태 머신입니다. 상태 머신은 컴퓨터 과학 개념으로, 한 기계가 여러 상태를 가질 수 있지만 주어진 시간에는 한 가지 상태만 가질 수 있습니다. 시스템의 현재 상태를 설명하는 상태와 상태 전환을 트리거하는 트랜잭션이 있습니다. 상태 S와 트랜잭션 T가 주어지면 상태 머신은 새로운 상태 S'를 반환합니다.

```
+--------+                 +--------+
|        |                 |        |
|   S    +---------------->+   S'   |
|        |    apply(T)     |        |
+--------+                 +--------+
```

실제로는 트랜잭션이 블록으로 묶여 프로세스를 더 효율적으로 만듭니다. 상태 S와 트랜잭션 블록 B가 주어지면 상태 머신은 새로운 상태 S'를 반환합니다.

```
+--------+                              +--------+
|        |                              |        |
|   S    +----------------------------> |   S'   |
|        |   For each T in B: apply(T)  |        |
+--------+                              +--------+
```

블록체인 맥락에서 상태 머신은 결정론적입니다. 즉, 노드가 주어진 상태에서 시작하여 동일한 트랜잭션 시퀀스를 반복하면 항상 동일한 최종 상태로 끝납니다. 코스모스 SDK는 개발자가 애플리케이션의 상태, 트랜잭션 유형 및 상태 전환 함수를 최대한 유연하게 정의할 수 있도록 지원합니다. 코스모스 SDK로 상태 머신을 구축하는 과정은 다음 섹션에서 더 자세히 설명하겠습니다. 하지만 먼저 CometBFT를 사용하여 상태 머신을 복제하는 방법을 살펴보겠습니다.

## CometBFT

- Cosmos SDK 덕분에 개발자는 상태 머신을 정의하기만 하면 네트워크를 통한 복제를 CometBFT가 대신 처리합니다.

```
                ^  +-------------------------------+  ^
                |  |                               |  |   Built with Cosmos SDK
                |  |  State-machine = Application  |  |
                |  |                               |  v
                |  +-------------------------------+
                |  |                               |  ^
Blockchain node |  |           Consensus           |  |
                |  |                               |  |
                |  +-------------------------------+  |   CometBFT
                |  |                               |  |
                |  |           Networking          |  |
                |  |                               |  |
                v  +-------------------------------+  v
```

- CometBFT는 애플리케이션에 구애받지 않는 엔진으로, 블록체인의 네트워킹 및 합의 레이어를 처리합니다. 실제로는 트랜잭션 바이트의 전파 및 순서를 담당하는 엔진입니다. CometBFT는 거래 순서에 대한 합의에 도달하기 위해 시조인 비잔틴 장애 허용(BFT) 알고리즘에 의존합니다.

- CometBFT 합의 알고리즘은 검증자라는 특수 노드 집합과 함께 작동합니다. 검증자는 블록체인에 트랜잭션 블록을 추가하는 역할을 담당합니다. 특정 블록에는 검증자 세트 V가 존재하며, 알고리즘에 의해 V의 검증자가 다음 블록의 제안자로 선택됩니다. 이 블록은 V의 3분의 2 이상이 사전 투표와 사전 커밋에 서명하고 블록에 포함된 모든 트랜잭션이 유효하면 유효한 것으로 간주됩니다. 검증자 세트는 스테이트 머신에 작성된 규칙에 의해 변경될 수 있습니다.

## ABCI

CometBFT는 애플리케이션이 구현해야 하는 ABCI라는 인터페이스를 통해 애플리케이션에 트랜잭션을 전달합니다.

```
              +---------------------+
              |                     |
              |     Application     |
              |                     |
              +--------+---+--------+
                       ^   |
                       |   | ABCI
                       |   v
              +--------+---+--------+
              |                     |
              |                     |
              |       CometBFT      |
              |                     |
              |                     |
              +---------------------+
```

CometBFT는 트랜잭션 바이트만 처리한다는 점에 유의하세요. 이러한 바이트가 무엇을 의미하는지에 대한 지식이 없습니다. CometBFT는 이러한 트랜잭션 바이트를 결정론적으로 정렬할 뿐입니다. CometBFT는 ABCI를 통해 애플리케이션에 바이트를 전달하고, 트랜잭션에 포함된 메시지가 성공적으로 처리되었는지 여부를 알려주는 반환 코드를 기대합니다. 다음은 ABCI의 가장 중요한 메시지입니다:

* CheckTx: CometBFT가 트랜잭션을 수신하면 애플리케이션에 전달하여 몇 가지 기본 요구 사항이 충족되는지 확인합니다. CheckTx는 스팸 트랜잭션으로부터 풀 노드의 멤풀을 보호하는 데 사용됩니다. . 충분한 수수료가 있는지 확인하고 서명을 검증하는 등 일련의 검증 단계를 실행하기 위해 AnteHandler라는 특수 핸들러가 사용됩니다. 확인이 유효하면 트랜잭션이 멤풀에 추가되고 피어 노드에 릴레이됩니다. 트랜잭션은 아직 블록에 포함되지 않았으므로 CheckTx에서는 처리되지 않습니다(즉, 상태 수정이 일어나지 않습니다). 

* DeliverTx: 유효한 블록이 CometBFT에 수신되면, 블록의 각 트랜잭션은 처리를 위해 DeliverTx를 통해 애플리케이션에 전달됩니다. 이 단계에서 상태 전환이 발생합니다. 트랜잭션의 각 메시지에 대한 실제 메시지 서비스 RPC와 함께 AnteHandler가 다시 실행됩니다. 

* BeginBlock/EndBlock: 이 메시지는 블록에 트랜잭션이 포함되어 있는지 여부에 관계없이 각 블록의 시작과 끝에서 실행됩니다. 로직의 자동 실행을 트리거하는 데 유용합니다. 하지만 계산 비용이 많이 드는 루프는 블록체인 속도를 늦추거나 루프가 무한대인 경우 블록체인을 정지시킬 수 있으므로 주의해서 진행하세요.

ABCI 메서드에 대한 자세한 내용은 CometBFT 문서에서 확인할 수 있습니다. CometBFT를 기반으로 구축된 모든 애플리케이션은 기본 로컬 CometBFT 엔진과 통신하기 위해 ABCI 인터페이스를 구현해야 합니다. 다행히도 ABCI 인터페이스를 구현할 필요는 없습니다. Cosmos SDK는 이를 상용구 형태로 구현한 베이스앱을 제공합니다.

